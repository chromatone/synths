import{h as T,j as B}from"./framework.71e127f7.js";var R={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL},M=(e,t={})=>{let r=t.globals?{...R,...t.globals}:R;return{globals:r,url:new r.URL(e),with(n){return{...this,...n(this)}}}};async function $(e){var r;let t=(r=e.headers.get("Content-Type"))==null?void 0:r.toLowerCase();if(t!=null&&t.startsWith("application/json")||t!=null&&t.startsWith("application/health+json")){let n=await e.json();if(!e.ok)throw n;return"data"in n?n.data:n}if(t!=null&&t.startsWith("text/html")||t!=null&&t.startsWith("text/plain")){let n=await e.text();if(!e.ok)throw n;return n}}var v=async(e,t,r=globalThis.fetch)=>{t.headers=typeof t.headers=="object"&&!Array.isArray(t.headers)?t.headers:{};let n=await r(e,t);return await $(n).catch(s=>{throw{errors:typeof s=="object"&&"errors"in s?s.errors:s,response:n}})},q=e=>{let t={};if(Array.isArray(e.fields)&&e.fields.length>0){let r=(n,s=[])=>{if(typeof n=="object"){let c=[];for(let i in n){let f=n[i]??[];if(Array.isArray(f))for(let y of f)c.push(r(y,[...s,i]));else if(typeof f=="object")for(let y of Object.keys(f)){let w=f[y];for(let S of w)c.push(r(S,[...s,`${i}:${y}`]))}}return c.flatMap(i=>i)}return[...s,String(n)].join(".")};t.fields=e.fields.flatMap(n=>r(n)).join(",")}return e.filter&&Object.keys(e.filter).length>0&&(t.filter=JSON.stringify(e.filter)),e.search&&(t.search=e.search),"sort"in e&&e.sort&&(t.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(t.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(t.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(t.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(t.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(t.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(t.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(t.groupBy=e.groupBy.join(",")),t},D=(e,t)=>{if(e.length===0)throw new Error(t)},I=(e,t)=>{if(String(e).startsWith("directus_"))throw new Error(t)},G=(e,t)=>()=>(D(String(e),"Collection cannot be empty"),I(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:t??{},method:"GET"}),F=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),Q={},X=(e={})=>t=>{let r={...Q,...e};return{async request(n){let s=n();if(s.headers||(s.headers={}),"Content-Type"in s.headers?s.headers["Content-Type"]==="multipart/form-data"&&delete s.headers["Content-Type"]:s.headers["Content-Type"]="application/json","getToken"in this){let y=await this.getToken();y&&(s.headers||(s.headers={}),s.headers.Authorization=`Bearer ${y}`)}let c=O(t.url,s.path,s.params),i={method:s.method??"GET",headers:s.headers??{}};"credentials"in r&&(i.credentials=r.credentials),s.body&&(i.body=s.body),s.onRequest&&(i=await s.onRequest(i)),r.onRequest&&(i=await r.onRequest(i));let f=await v(c.toString(),i,t.globals.fetch);return"onResponse"in s&&(f=await s.onResponse(f,i)),"onResponse"in e&&(f=await e.onResponse(f,i)),f}}},E="/",z=(e,t)=>(e.endsWith(E)&&(e=e.slice(0,-1)),t.startsWith(E)||(t=E+t),e+t),O=(e,t,r)=>{let n=e.pathname===E?t:z(e.pathname,t),s=new globalThis.URL(n,e);if(r)for(let[c,i]of Object.entries(q(r)))if(i&&typeof i=="object"&&!Array.isArray(i))for(let[f,y]of Object.entries(i))s.searchParams.set(`${c}[${f}]`,String(y));else s.searchParams.set(c,i);return s},H=()=>{let e=null;return{get:async()=>e,set:async t=>{e=t}}},K={msRefreshBeforeExpires:3e4,autoRefresh:!0},V=(e="cookie",t={})=>r=>{let n={...K,...t},s=null,c=null,i=n.storage??H(),f=()=>{i.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},y=async()=>{try{await s}finally{s=null}},w=async()=>{let l=await i.get();if(s||!(l!=null&&l.expires_at)){await y();return}l.expires_at<new Date().getTime()+n.msRefreshBeforeExpires&&p().catch(a=>{}),await y()},S=l=>{let a=l.expires??0;l.expires_at=new Date().getTime()+a,i.set(l),n.autoRefresh&&a>n.msRefreshBeforeExpires&&a<Number.MAX_SAFE_INTEGER&&(c&&clearTimeout(c),c=setTimeout(()=>{c=null,p().catch(o=>{})},a-n.msRefreshBeforeExpires))},p=async()=>(s=(async()=>{let l=await i.get();f();let a={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in n&&(a.credentials=n.credentials);let o={mode:e};e==="json"&&(l!=null&&l.refresh_token)&&(o.refresh_token=l.refresh_token),a.body=JSON.stringify(o);let u=O(r.url,"/auth/refresh"),h=await v(u.toString(),a,r.globals.fetch);return S(h),h})().catch(l=>{throw l}),s);return{refresh:p,async login(l,a,o={}){f();let u=O(r.url,"/auth/login"),h={email:l,password:a};"otp"in o&&(h.otp=o.otp),h.mode=o.mode??e;let m={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)};"credentials"in n&&(m.credentials=n.credentials);let g=await v(u.toString(),m,r.globals.fetch);return S(g),g},async logout(){let l=await i.get(),a={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in n&&(a.credentials=n.credentials),e==="json"&&(l!=null&&l.refresh_token)&&(a.body=JSON.stringify({refresh_token:l.refresh_token}));let o=O(r.url,"/auth/logout");await v(o.toString(),a,r.globals.fetch),c&&clearTimeout(c),f()},async getToken(){var l;return await w(),((l=await i.get())==null?void 0:l.access_token)??null},setToken(l){i.set({access_token:l,refresh_token:null,expires:null,expires_at:null})}}};function x(e){return JSON.stringify({...e,type:"auth"})}var Y=()=>JSON.stringify({type:"pong"}),L=(e,t=1e3)=>new Promise((r,n)=>{let s=y=>{try{let w=JSON.parse(y.data);typeof w=="object"&&!Array.isArray(w)&&w!==null?(i(),r(w)):(i(),c())}catch{i(),r(y)}},c=()=>n(),i=()=>{clearTimeout(f),e.removeEventListener("message",s),e.removeEventListener("error",c),e.removeEventListener("close",c)};e.addEventListener("message",s),e.addEventListener("error",c),e.addEventListener("close",c);let f=setTimeout(()=>{i(),r(void 0)},t)});function*W(){let e=1;for(;;)yield String(e),e++}var Z={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}};function ee(e={}){return t=>{e={...Z,...e};let r=null,n=W(),s=0,c=!1,i=a=>"getToken"in a,f=async(a,o)=>{if(e.authMode==="strict"&&i(o)){let u=await o.getToken();u&&a.searchParams.set("access_token",u)}return a},y=async a=>{if("url"in e)return await f(new t.globals.URL(e.url),a);if(["ws:","wss:"].includes(t.url.protocol))return await f(t.url,a);let o=new t.globals.URL(t.url.toString());return o.protocol=t.url.protocol==="https:"?"wss:":"ws:",o.pathname="/websocket",await f(o,a)},w=()=>{r=null,n=W()};function S(){e.reconnect&&!c&&s<e.reconnect.retries?(c=!0,setTimeout(()=>{s+=1,this.connect().then(()=>{s=0,c=!1}).catch(()=>{})},Math.max(1,e.reconnect.delay))):c=!1}let p={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},l=async(a,o)=>{for(;a.readyState!==WebSocket.CLOSED;){let u=await L(a).catch(()=>{});if(u){if("type"in u){if(u.type==="auth"&&"status"in u&&u.status==="error"&&"error"in u){if(u.error==="TOKEN_EXPIRED"&&i(o)){let h=await o.getToken();if(h){a.send(x({access_token:h}));continue}}if(u.error==="AUTH_TIMEOUT"){a.close();continue}}if(e.heartbeat&&u.type==="ping"){a.send(Y());continue}}p.message.forEach(h=>h.call(a,u))}}};return{async connect(){let a=this,o=await y(a);return new Promise((u,h)=>{let m=!1,g=new t.globals.WebSocket(o);g.addEventListener("open",async d=>{if(e.authMode==="handshake"&&i(a)){let b=await a.getToken();b&&g.send(x({access_token:b}))}m=!0,p.open.forEach(b=>b.call(g,d)),l(g,a),u()}),g.addEventListener("error",d=>{p.error.forEach(b=>b.call(g,d)),g.close(),m||h(d)}),g.addEventListener("close",d=>{p.close.forEach(b=>b.call(g,d)),w(),S.call(this),m||h(d)}),r=g})},disconnect(){r&&(r==null?void 0:r.readyState)===WebSocket.OPEN&&r.close(),r=null},onWebSocket(a,o){if(a==="message"){let u=function(h){if(typeof h.data!="string")return o.call(this,h);try{return o.call(this,JSON.parse(h.data))}catch{return o.call(this,h)}};return p[a].add(u),()=>p[a].delete(u)}return p[a].add(o),()=>p[a].delete(o)},sendMessage(a){if(!r||(r==null?void 0:r.readyState)!==WebSocket.OPEN)throw new Error("websocket connection not OPEN");if(typeof a=="string"){r.send(a);return}"uid"in a||(a.uid=n.next().value),r==null||r.send(JSON.stringify(a))},async subscribe(a,o={}){(!r||r.readyState!==WebSocket.OPEN)&&await this.connect(),"uid"in o||(o.uid=n.next().value);let u=!0,h=r,m=d=>h.send(JSON.stringify(d));m({...o,collection:a,type:"subscribe"});async function*g(){for(;u&&h&&h.readyState===WebSocket.OPEN;){let d=await L(h).catch(()=>{});if(d){if("type"in d&&"status"in d&&d.type==="subscribe"&&d.status==="error")throw d;"type"in d&&"uid"in d&&d.type==="subscription"&&d.uid===o.uid&&(yield d)}}if(e.reconnect&&c){for(;c;)await te(10);r&&r.readyState===WebSocket.OPEN&&(r.send(JSON.stringify({...o,collection:a,type:"subscribe"})),yield*g())}}return{subscription:g(),unsubscribe(){m({uid:o.uid,type:"unsubscribe"}),u=!1}}}}}}var te=e=>new Promise(t=>setTimeout(()=>t(),e));class re{get(){return JSON.parse(localStorage.getItem("directus-data"))}set(t){localStorage.setItem("directus-data",JSON.stringify(t))}}const k=M("https://db.chromatone.center/").with(X({credentials:"include"})).with(V("json",{credentials:"include",storage:new re})).with(ee({credentials:"include"})),j=T(),C=T(""),U=T(""),_=T({}),N=T("");let J=!1;function oe(){return J||(B(async()=>{await P(),await A()}),J=!0),{access_token:N,email:C,password:U,authData:_,user:j,userDB:k,userCreate:se,userRead:A,refreshToken:P,submitLogin:ae,logoutUser:ne}}async function P(){try{let e=await k.refresh();N.value=e.access_token,delete e.access_token,_.value=e}catch(e){console.log(e.errors[0])}}async function ae(){try{let e=await k.login(C.value,U.value);N.value=e.access_token,delete e.access_token,_.value={...e}}catch(e){console.log(e.errors[0])}}async function A(){try{return j.value=await k.request(F()),j.value.players=await k.request(G("players",{fields:["*",{synths:["*",{synths_id:["*"]}]}]})),j.value}catch(e){console.log(e)}}async function se({email:e}){}async function ne(){await k.logout(),N.value="",_.value=""}export{oe as u};
