import{r as v,e as X,o as N,c as R,a as y,t as $,u as m,w as C,v as A,i as W,f as z,g as G,_ as H}from"./chunks/framework.77790655.js";var J={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL},K=(e,t={})=>{let r=t.globals?{...J,...t.globals}:J;return{globals:r,url:new r.URL(e),with(o){return{...this,...o(this)}}}};async function Y(e){var r;let t=(r=e.headers.get("Content-Type"))==null?void 0:r.toLowerCase();if(t!=null&&t.startsWith("application/json")||t!=null&&t.startsWith("application/health+json")){let o=await e.json();if(!e.ok)throw o;return"data"in o?o.data:o}if(t!=null&&t.startsWith("text/html")||t!=null&&t.startsWith("text/plain")){let o=await e.text();if(!e.ok)throw o;return o}}var T=async(e,t,r=globalThis.fetch)=>{t.headers=typeof t.headers=="object"&&!Array.isArray(t.headers)?t.headers:{};let o=await r(e,t);return await Y(o).catch(a=>{throw{errors:typeof a=="object"&&"errors"in a?a.errors:a,response:o}})},Z=e=>{let t={};if(Array.isArray(e.fields)&&e.fields.length>0){let r=(o,a=[])=>{if(typeof o=="object"){let c=[];for(let l in o){let d=o[l]??[];if(Array.isArray(d))for(let f of d)c.push(r(f,[...a,l]));else if(typeof d=="object")for(let f of Object.keys(d)){let w=d[f];for(let _ of w)c.push(r(_,[...a,`${l}:${f}`]))}}return c.flatMap(l=>l)}return[...a,String(o)].join(".")};t.fields=e.fields.flatMap(o=>r(o)).join(",")}return e.filter&&Object.keys(e.filter).length>0&&(t.filter=JSON.stringify(e.filter)),e.search&&(t.search=e.search),"sort"in e&&e.sort&&(t.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(t.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(t.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(t.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(t.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(t.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(t.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(t.groupBy=e.groupBy.join(",")),t},ee=(e,t)=>{if(e.length===0)throw new Error(t)},te=(e,t)=>{if(String(e).startsWith("directus_"))throw new Error(t)},re=(e,t)=>()=>(ee(String(e),"Collection cannot be empty"),te(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:t??{},method:"GET"}),se=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),ae={},ne=(e={})=>t=>{let r={...ae,...e};return{async request(o){let a=o();if(a.headers||(a.headers={}),"Content-Type"in a.headers?a.headers["Content-Type"]==="multipart/form-data"&&delete a.headers["Content-Type"]:a.headers["Content-Type"]="application/json","getToken"in this){let f=await this.getToken();f&&(a.headers||(a.headers={}),a.headers.Authorization=`Bearer ${f}`)}let c=O(t.url,a.path,a.params),l={method:a.method??"GET",headers:a.headers??{}};"credentials"in r&&(l.credentials=r.credentials),a.body&&(l.body=a.body),a.onRequest&&(l=await a.onRequest(l)),r.onRequest&&(l=await r.onRequest(l));let d=await T(c.toString(),l,t.globals.fetch);return"onResponse"in a&&(d=await a.onResponse(d,l)),"onResponse"in e&&(d=await e.onResponse(d,l)),d}}},E="/",oe=(e,t)=>(e.endsWith(E)&&(e=e.slice(0,-1)),t.startsWith(E)||(t=E+t),e+t),O=(e,t,r)=>{let o=e.pathname===E?t:oe(e.pathname,t),a=new globalThis.URL(o,e);if(r)for(let[c,l]of Object.entries(Z(r)))if(l&&typeof l=="object"&&!Array.isArray(l))for(let[d,f]of Object.entries(l))a.searchParams.set(`${c}[${d}]`,String(f));else a.searchParams.set(c,l);return a},ie=()=>{let e=null;return{get:async()=>e,set:async t=>{e=t}}},le={msRefreshBeforeExpires:3e4,autoRefresh:!0},ce=(e="cookie",t={})=>r=>{let o={...le,...t},a=null,c=null,l=o.storage??ie(),d=()=>{l.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},f=async()=>{try{await a}finally{a=null}},w=async()=>{let i=await l.get();if(a||!(i!=null&&i.expires_at)){await f();return}i.expires_at<new Date().getTime()+o.msRefreshBeforeExpires&&b().catch(s=>{}),await f()},_=i=>{let s=i.expires??0;i.expires_at=new Date().getTime()+s,l.set(i),o.autoRefresh&&s>o.msRefreshBeforeExpires&&s<Number.MAX_SAFE_INTEGER&&(c&&clearTimeout(c),c=setTimeout(()=>{c=null,b().catch(n=>{})},s-o.msRefreshBeforeExpires))},b=async()=>(a=(async()=>{let i=await l.get();d();let s={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in o&&(s.credentials=o.credentials);let n={mode:e};e==="json"&&(i!=null&&i.refresh_token)&&(n.refresh_token=i.refresh_token),s.body=JSON.stringify(n);let u=O(r.url,"/auth/refresh"),h=await T(u.toString(),s,r.globals.fetch);return _(h),h})().catch(i=>{throw i}),a);return{refresh:b,async login(i,s,n={}){d();let u=O(r.url,"/auth/login"),h={email:i,password:s};"otp"in n&&(h.otp=n.otp),h.mode=n.mode??e;let k={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)};"credentials"in o&&(k.credentials=o.credentials);let g=await T(u.toString(),k,r.globals.fetch);return _(g),g},async logout(){let i=await l.get(),s={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in o&&(s.credentials=o.credentials),e==="json"&&(i!=null&&i.refresh_token)&&(s.body=JSON.stringify({refresh_token:i.refresh_token}));let n=O(r.url,"/auth/logout");await T(n.toString(),s,r.globals.fetch),c&&clearTimeout(c),d()},async getToken(){var i;return await w(),((i=await l.get())==null?void 0:i.access_token)??null},setToken(i){l.set({access_token:i,refresh_token:null,expires:null,expires_at:null})}}};function U(e){return JSON.stringify({...e,type:"auth"})}var de=()=>JSON.stringify({type:"pong"}),B=(e,t=1e3)=>new Promise((r,o)=>{let a=f=>{try{let w=JSON.parse(f.data);typeof w=="object"&&!Array.isArray(w)&&w!==null?(l(),r(w)):(l(),c())}catch{l(),r(f)}},c=()=>o(),l=()=>{clearTimeout(d),e.removeEventListener("message",a),e.removeEventListener("error",c),e.removeEventListener("close",c)};e.addEventListener("message",a),e.addEventListener("error",c),e.addEventListener("close",c);let d=setTimeout(()=>{l(),r(void 0)},t)});function*D(){let e=1;for(;;)yield String(e),e++}var ue={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}};function he(e={}){return t=>{e={...ue,...e};let r=null,o=D(),a=0,c=!1,l=s=>"getToken"in s,d=async(s,n)=>{if(e.authMode==="strict"&&l(n)){let u=await n.getToken();u&&s.searchParams.set("access_token",u)}return s},f=async s=>{if("url"in e)return await d(new t.globals.URL(e.url),s);if(["ws:","wss:"].includes(t.url.protocol))return await d(t.url,s);let n=new t.globals.URL(t.url.toString());return n.protocol=t.url.protocol==="https:"?"wss:":"ws:",n.pathname="/websocket",await d(n,s)},w=()=>{r=null,o=D()};function _(){e.reconnect&&!c&&a<e.reconnect.retries?(c=!0,setTimeout(()=>{a+=1,this.connect().then(()=>{a=0,c=!1}).catch(()=>{})},Math.max(1,e.reconnect.delay))):c=!1}let b={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},i=async(s,n)=>{for(;s.readyState!==WebSocket.CLOSED;){let u=await B(s).catch(()=>{});if(u){if("type"in u){if(u.type==="auth"&&"status"in u&&u.status==="error"&&"error"in u){if(u.error==="TOKEN_EXPIRED"&&l(n)){let h=await n.getToken();if(h){s.send(U({access_token:h}));continue}}if(u.error==="AUTH_TIMEOUT"){s.close();continue}}if(e.heartbeat&&u.type==="ping"){s.send(de());continue}}b.message.forEach(h=>h.call(s,u))}}};return{async connect(){let s=this,n=await f(s);return new Promise((u,h)=>{let k=!1,g=new t.globals.WebSocket(n);g.addEventListener("open",async p=>{if(e.authMode==="handshake"&&l(s)){let S=await s.getToken();S&&g.send(U({access_token:S}))}k=!0,b.open.forEach(S=>S.call(g,p)),i(g,s),u()}),g.addEventListener("error",p=>{b.error.forEach(S=>S.call(g,p)),g.close(),k||h(p)}),g.addEventListener("close",p=>{b.close.forEach(S=>S.call(g,p)),w(),_.call(this),k||h(p)}),r=g})},disconnect(){r&&(r==null?void 0:r.readyState)===WebSocket.OPEN&&r.close(),r=null},onWebSocket(s,n){if(s==="message"){let u=function(h){if(typeof h.data!="string")return n.call(this,h);try{return n.call(this,JSON.parse(h.data))}catch{return n.call(this,h)}};return b[s].add(u),()=>b[s].delete(u)}return b[s].add(n),()=>b[s].delete(n)},sendMessage(s){if(!r||(r==null?void 0:r.readyState)!==WebSocket.OPEN)throw new Error("websocket connection not OPEN");if(typeof s=="string"){r.send(s);return}"uid"in s||(s.uid=o.next().value),r==null||r.send(JSON.stringify(s))},async subscribe(s,n={}){(!r||r.readyState!==WebSocket.OPEN)&&await this.connect(),"uid"in n||(n.uid=o.next().value);let u=!0,h=r,k=p=>h.send(JSON.stringify(p));k({...n,collection:s,type:"subscribe"});async function*g(){for(;u&&h&&h.readyState===WebSocket.OPEN;){let p=await B(h).catch(()=>{});if(p){if("type"in p&&"status"in p&&p.type==="subscribe"&&p.status==="error")throw p;"type"in p&&"uid"in p&&p.type==="subscription"&&p.uid===n.uid&&(yield p)}}if(e.reconnect&&c){for(;c;)await fe(10);r&&r.readyState===WebSocket.OPEN&&(r.send(JSON.stringify({...n,collection:s,type:"subscribe"})),yield*g())}}return{subscription:g(),unsubscribe(){k({uid:n.uid,type:"unsubscribe"}),u=!1}}}}}}var fe=e=>new Promise(t=>setTimeout(()=>t(),e));class pe{get(){return JSON.parse(localStorage.getItem("directus-data"))}set(t){localStorage.setItem("directus-data",JSON.stringify(t))}}const x=K("https://synthdb.chromatone.center/").with(ne({credentials:"include"})).with(ce("json",{credentials:"include",storage:new pe})).with(he({credentials:"include"})),j=v(),V=v(""),F=v(""),L=v({}),P=v("");let M=!1;function Q(){return M||(X(async()=>{await I(),await q()}),M=!0),{access_token:P,email:V,password:F,authData:L,user:j,userDB:x,userCreate:ye,userRead:q,refreshToken:I,submitLogin:ge,logoutUser:be}}async function I(){try{let e=await x.refresh();P.value=e.access_token,delete e.access_token,L.value=e}catch(e){console.log(e.errors[0])}}async function ge(){try{let e=await x.login(V.value,F.value);P.value=e.access_token,delete e.access_token,L.value={...e}}catch(e){console.log(e.errors[0])}}async function q(){try{return j.value=await x.request(se()),j.value.players=await x.request(re("players",{fields:["*",{synths:["*",{synths_id:["*"]}]}]})),j.value}catch(e){console.log(e)}}async function ye({email:e}){}async function be(){await x.logout(),P.value="",L.value=""}const me={class:"flex flex-col gap-4 p-4"},we=y("div",{class:"text-xl"},"Profile",-1),ke={class:"text-sm"},_e={__name:"AuthProfile",setup(e){const{user:t}=Q();return(r,o)=>(N(),R("div",me,[we,y("pre",ke,$(m(t)),1)]))}},Se=y("div",{class:"text-4xl"},"Login to your account",-1),xe=y("label",{class:"text-xl",for:"email"},"E-mail*:",-1),ve=y("label",{class:"text-xl",for:"email"},"Password:",-1),Te={key:1,class:"flex flex-col gap-2"},Ee={class:"font-mono text-xs"},Oe={class:"text-sm"},je={class:"flex"},Ne={__name:"AuthLogin",setup(e){const{userRead:t,user:r,userDB:o,email:a,password:c,authData:l,access_token:d,submitLogin:f,refreshToken:w,logoutUser:_}=Q();return(b,i)=>{const s=_e;return m(d)?(N(),R("div",Te,[y("p",Ee,"."+$(m(d).split(".")[2]),1),y("pre",Oe,$(m(l)),1),y("div",je,[y("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:i[4]||(i[4]=n=>m(w)())},"Refresh"),y("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:i[5]||(i[5]=n=>m(_)())},"Log out")]),y("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:i[6]||(i[6]=n=>m(t)())},"Read user"),G(s)])):(N(),R("form",{key:0,class:"flex flex-col gap-4",onSubmit:i[3]||(i[3]=z((...n)=>m(f)&&m(f)(...n),["prevent"]))},[Se,xe,C(y("input",{class:"text-lg rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",id:"email",type:"text","onUpdate:modelValue":i[0]||(i[0]=n=>W(a)?a.value=n:null)},null,512),[[A,m(a)]]),ve,C(y("input",{class:"rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",type:"password","onUpdate:modelValue":i[1]||(i[1]=n=>W(c)?c.value=n:null)},null,512),[[A,m(c)]]),y("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:i[2]||(i[2]=(...n)=>m(f)&&m(f)(...n))},"Sign In")],32))}}},$e=JSON.parse('{"title":"Login","description":"","frontmatter":{"title":"Login","desctiption":"Get in touch with community through contributions"},"headers":[],"relativePath":"auth/index.md","filePath":"auth/index.md","lastUpdated":1698500362000}'),Re={name:"auth/index.md"};function Le(e,t,r,o,a,c){const l=Ne;return N(),R("div",null,[G(l)])}const Ce=H(Re,[["render",Le]]);export{$e as __pageData,Ce as default};
