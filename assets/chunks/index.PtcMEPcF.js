function J(e){return e?`/auth/login/${e}`:"/auth/login"}var E="/",$=(e,n)=>(e.endsWith(E)&&(e=e.slice(0,-1)),n.startsWith(E)||(n=E+n),e+n),O=(e,n,s)=>{let t=e.pathname===E?n:$(e.pathname,n),r=new globalThis.URL(t,e);if(s)for(let[l,a]of Object.entries(H(s)))if(a&&typeof a=="object"&&!Array.isArray(a))for(let[d,u]of Object.entries(a))r.searchParams.set(`${l}[${d}]`,String(u));else r.searchParams.set(l,a);return r};function W(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function B(e){var n;if(!(typeof e!="object"||!e)){if(W(e)){let s=(n=e.headers.get("Content-Type"))==null?void 0:n.toLowerCase();if(s!=null&&s.startsWith("application/json")||s!=null&&s.startsWith("application/health+json")){let t=await e.json();if(!e.ok)throw t;return"data"in t?t.data:t}if(s!=null&&s.startsWith("text/html")||s!=null&&s.startsWith("text/plain")){let t=await e.text();if(!e.ok)throw t;return t}return e}return"data"in e?e.data:e}}var R=async(e,n,s=globalThis.fetch)=>(n.headers=typeof n.headers=="object"&&!Array.isArray(n.headers)?n.headers:{},s(e,n).then(t=>B(t).catch(r=>{let l=typeof r=="object"&&"errors"in r?r.errors:r;return Promise.reject({errors:l,response:t})}))),U=()=>{let e=null;return{get:async()=>e,set:async n=>{e=n}}},P={msRefreshBeforeExpires:3e4,autoRefresh:!0},D=2**31-1,z=(e="cookie",n={})=>s=>{let t={...P,...n},r=null,l=null,a=t.storage??U(),d=async()=>a.set({access_token:null,refresh_token:null,expires:null,expires_at:null}),u=async()=>{try{await r}finally{r=null}},w=async()=>{let c=await a.get();return r||!(c!=null&&c.expires_at)||c.expires_at<new Date().getTime()+t.msRefreshBeforeExpires&&S().catch(p=>{}),u()},j=async c=>{let p=c.expires??0;c.expires_at=new Date().getTime()+p,await a.set(c),t.autoRefresh&&p>t.msRefreshBeforeExpires&&p<D&&(l&&clearTimeout(l),l=setTimeout(()=>{l=null,S().catch(y=>{})},p-t.msRefreshBeforeExpires))},S=async()=>(r=(async()=>{let c=await a.get();await d();let p={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in t&&(p.credentials=t.credentials);let y={mode:e};e==="json"&&(c!=null&&c.refresh_token)&&(y.refresh_token=c.refresh_token),p.body=JSON.stringify(y);let m=O(s.url,"/auth/refresh");return R(m.toString(),p,s.globals.fetch).then(i=>j(i).then(()=>i))})(),r);return{refresh:S,async login(c,p,y={}){await d();let m={email:c,password:p};"otp"in y&&(m.otp=y.otp),m.mode=y.mode??e;let i=J(y.provider),o=O(s.url,i),f={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)};"credentials"in t&&(f.credentials=t.credentials);let h=await R(o.toString(),f,s.globals.fetch);return await j(h),h},async logout(){let c=await a.get(),p={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in t&&(p.credentials=t.credentials);let y={mode:e};e==="json"&&(c!=null&&c.refresh_token)&&(y.refresh_token=c.refresh_token),p.body=JSON.stringify(y);let m=O(s.url,"/auth/logout");await R(m.toString(),p,s.globals.fetch),this.stopRefreshing(),await d()},stopRefreshing(){l&&clearTimeout(l)},async getToken(){var c;return await w().catch(()=>{}),((c=await a.get())==null?void 0:c.access_token)??null},async setToken(c){return a.set({access_token:c,refresh_token:null,expires:null,expires_at:null})}}},M={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL,logger:globalThis.console},Q=(e,n={})=>{let s=n.globals?{...M,...n.globals}:M;return{globals:s,url:new s.URL(e),with(t){return{...this,...t(this)}}}};function A(e){return JSON.stringify({...e,type:"auth"})}var I=()=>JSON.stringify({type:"pong"});function*N(){let e=1;for(;;)yield String(e),e++}var x=(e,n=1e3)=>new Promise((s,t)=>{let r=u=>{try{let w=JSON.parse(u.data);typeof w=="object"&&!Array.isArray(w)&&w!==null?(a(),s(w)):(a(),l())}catch{a(),s(u)}},l=()=>t(),a=()=>{clearTimeout(d),e.removeEventListener("message",r),e.removeEventListener("error",l),e.removeEventListener("close",l)};e.addEventListener("message",r),e.addEventListener("error",l),e.addEventListener("close",l);let d=setTimeout(()=>{a(),s(void 0)},n)}),q={authMode:"handshake",heartbeat:!0,debug:!1,reconnect:{delay:1e3,retries:10}};function X(e={}){return n=>{e={...q,...e};let s=N(),t={code:"closed"},r={attempts:0,active:!1},l=!1,a=new Set,d=i=>"getToken"in i,u=(i,...o)=>e.debug&&n.globals.logger[i]("[Directus SDK]",...o),w=async(i,o)=>{let f=new n.globals.URL(i);if(e.authMode==="strict"&&d(o)){let h=await o.getToken();h&&f.searchParams.set("access_token",h)}return f.toString()},j=async i=>{if("url"in e)return await w(e.url,i);if(["ws:","wss:"].includes(n.url.protocol))return await w(n.url,i);let o=new n.globals.URL(n.url.toString());return o.protocol=n.url.protocol==="https:"?"wss:":"ws:",o.pathname="/websocket",await w(o,i)},S=i=>{let o=new Promise((f,h)=>{if(!e.reconnect||l)return h();if(u("info",`reconnect #${r.attempts} `+(r.attempts>=e.reconnect.retries?"maximum retries reached":`trying again in ${Math.max(100,e.reconnect.delay)}ms`)),r.active)return r.active;if(r.attempts>=e.reconnect.retries)return r.attempts=-1,h();setTimeout(()=>i.connect().then(_=>(a.forEach(g=>{i.sendMessage(g)}),_)).then(f).catch(h),Math.max(100,e.reconnect.delay))});r.attempts+=1,r.active=o.catch(()=>{}).finally(()=>{r.active=!1})},c={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])};function p(i){return"type"in i&&"status"in i&&"error"in i&&"code"in i.error&&"message"in i.error&&i.type==="auth"&&i.status==="error"}async function y(i,o){if(t.code==="open"){if(i.error.code==="TOKEN_EXPIRED"&&(u("warn","Authentication token expired!"),d(o))){let f=await o.getToken();if(!f)throw Error("No token for re-authenticating the websocket");t.connection.send(A({access_token:f}))}if(i.error.code==="AUTH_TIMEOUT")return t.firstMessage&&e.authMode==="public"?(u("warn",'Authentication failed! Currently the "authMode" is "public" try using "handshake" instead'),e.reconnect=!1):u("warn","Authentication timed out!"),t.connection.close();if(i.error.code==="AUTH_FAILED"){if(t.firstMessage&&e.authMode==="public")return u("warn",'Authentication failed! Currently the "authMode" is "public" try using "handshake" instead'),e.reconnect=!1,t.connection.close();u("warn","Authentication failed!")}}}let m=async i=>{for(;t.code==="open";){let o=await x(t.connection).catch(()=>{});if(o){if(p(o)){await y(o,i),t.firstMessage=!1;continue}if(e.heartbeat&&o.type==="ping"){t.connection.send(I()),t.firstMessage=!1;continue}c.message.forEach(f=>{t.code==="open"&&f.call(t.connection,o)}),t.firstMessage=!1}}};return{async connect(){if(l=!1,t.code==="connecting")return await t.connection;if(t.code!=="closed")throw new Error(`Cannot connect when state is "${t.code}"`);let i=this,o=await j(i);u("info",`Connecting to ${o}...`);let f=new Promise((h,_)=>{let g=!1,b=new n.globals.WebSocket(o);b.addEventListener("open",async v=>{if(u("info","Connection open."),t={code:"open",connection:b,firstMessage:!0},r.attempts=0,r.active=!1,m(i),e.authMode==="handshake"&&d(i)){let k=await i.getToken();if(!k)throw Error("No token for authenticating the websocket. Make sure to provide one or call the login() function beforehand.");b.send(A({access_token:k}));let T=await x(b);if(T&&"type"in T&&"status"in T&&T.type==="auth"&&T.status==="ok")u("info","Authentication successful!");else return _("Authentication failed while opening websocket connection")}c.open.forEach(k=>k.call(b,v)),g=!0,h(b)}),b.addEventListener("error",v=>{u("warn","Connection errored."),c.error.forEach(k=>k.call(b,v)),b.close(),t={code:"error"},g||_(v)}),b.addEventListener("close",v=>{u("info","Connection closed."),c.close.forEach(k=>k.call(b,v)),s=N(),t={code:"closed"},S(this),g||_(v)})});return t={code:"connecting",connection:f},f},disconnect(){l=!0,t.code==="open"&&t.connection.close()},onWebSocket(i,o){if(i==="message"){let f=function(h){if(typeof h.data!="string")return o.call(this,h);try{return o.call(this,JSON.parse(h.data))}catch{return o.call(this,h)}};return c[i].add(f),()=>c[i].delete(f)}return c[i].add(o),()=>c[i].delete(o)},sendMessage(i){if(t.code!=="open")throw new Error('Cannot send messages without an open connection. Make sure you are calling "await client.connect()".');if(typeof i=="string")return t.connection.send(i);"uid"in i||(i.uid=s.next().value),t.connection.send(JSON.stringify(i))},async subscribe(i,o={}){"uid"in o||(o.uid=s.next().value),a.add({...o,collection:i,type:"subscribe"}),t.code!=="open"&&(u("info","No connection available for subscribing!"),await this.connect()),this.sendMessage({...o,collection:i,type:"subscribe"});let f=!0;async function*h(){for(;f&&t.code==="open";){let g=await x(t.connection).catch(()=>{});if(g){if("type"in g&&"status"in g&&g.type==="subscribe"&&g.status==="error")throw g;"type"in g&&"uid"in g&&g.type==="subscription"&&g.uid===o.uid&&(yield g)}}e.reconnect&&r.active&&(await r.active,t.code==="open"&&(t.connection.send(JSON.stringify({...o,collection:i,type:"subscribe"})),yield*h()))}let _=()=>{a.delete({...o,collection:i,type:"subscribe"}),this.sendMessage({uid:o.uid,type:"unsubscribe"}),f=!1};return{subscription:h(),unsubscribe:_}}}}}function G(e){return["directus_access","directus_activity","directus_collections","directus_fields","directus_files","directus_folders","directus_migrations","directus_permissions","directus_policies","directus_presets","directus_relations","directus_revisions","directus_roles","directus_sessions","directus_settings","directus_users","directus_webhooks","directus_dashboards","directus_panels","directus_notifications","directus_shares","directus_flows","directus_operations","directus_translations","directus_versions","directus_extensions"].includes(e)}var K=e=>{let n=(s,t=[])=>{if(typeof s=="object"){let r=[];for(let l in s){let a=s[l]??[];if(Array.isArray(a))for(let d of a)r.push(n(d,[...t,l]));else if(typeof a=="object")for(let d of Object.keys(a)){let u=a[d];for(let w of u)r.push(n(w,[...t,`${l}:${d}`]))}}return r.flatMap(l=>l)}return[...t,String(s)].join(".")};return e.flatMap(s=>n(s))},H=e=>{let n={};Array.isArray(e.fields)&&e.fields.length>0&&(n.fields=K(e.fields).join(",")),e.filter&&Object.keys(e.filter).length>0&&(n.filter=JSON.stringify(e.filter)),e.search&&(n.search=e.search),"sort"in e&&e.sort&&(n.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(n.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(n.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(n.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(n.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(n.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(n.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(n.groupBy=e.groupBy.join(","));for(let[s,t]of Object.entries(e))s in n||(typeof t=="string"||typeof t=="number"||typeof t=="boolean"?n[s]=String(t):n[s]=JSON.stringify(t));return n},C=(e,n)=>{if(e.length===0)throw new Error(n)},L=(e,n)=>{if(G(String(e)))throw new Error(n)},V=(e,n)=>()=>(C(String(e),"Collection cannot be empty"),L(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:n??{},method:"GET"}),Y=(e,n,s)=>()=>(C(String(e),"Collection cannot be empty"),L(e,"Cannot use readItem for core collections"),C(String(n),"Key cannot be empty"),{path:`/items/${e}/${n}`,params:s??{},method:"GET"}),Z=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),F={},ee=(e={})=>n=>{let s={...F,...e};return{async request(t){let r=t();if(r.headers||(r.headers={}),"Content-Type"in r.headers?r.headers["Content-Type"]==="multipart/form-data"&&delete r.headers["Content-Type"]:r.headers["Content-Type"]="application/json","getToken"in this){let u=await this.getToken();u&&(r.headers||(r.headers={}),r.headers.Authorization=`Bearer ${u}`)}let l=O(n.url,r.path,r.params),a={method:r.method??"GET",headers:r.headers??{}};"credentials"in s&&(a.credentials=s.credentials),r.body&&(a.body=r.body),r.onRequest&&(a=await r.onRequest(a)),s.onRequest&&(a=await s.onRequest(a));let d=await R(l.toString(),a,n.globals.fetch);return"onResponse"in r&&(d=await r.onResponse(d,a)),"onResponse"in e&&(d=await e.onResponse(d,a)),d}}};export{Y as N,ee as R,Z as k,Q as l,z as n,X as v,V as w};
