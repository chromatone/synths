var k={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL},v=(e,t={})=>{let i=t.globals?{...k,...t.globals}:k;return{globals:i,url:new i.URL(e),with(a){return{...this,...a(this)}}}};async function S(e){var i;let t=(i=e.headers.get("Content-Type"))==null?void 0:i.toLowerCase();if(t!=null&&t.startsWith("application/json")||t!=null&&t.startsWith("application/health+json")){let a=await e.json();if(!e.ok)throw a;return"data"in a?a.data:a}if(t!=null&&t.startsWith("text/html")||t!=null&&t.startsWith("text/plain")){let a=await e.text();if(!e.ok)throw a;return a}}var d=async(e,t,i=globalThis.fetch)=>{t.headers=typeof t.headers=="object"&&!Array.isArray(t.headers)?t.headers:{};let a=await i(e,t);return await S(a).catch(r=>{throw{errors:typeof r=="object"&&"errors"in r?r.errors:r,response:a}})},R=e=>{let t={};if(Array.isArray(e.fields)&&e.fields.length>0){let i=(a,r=[])=>{if(typeof a=="object"){let l=[];for(let s in a){let o=a[s]??[];if(Array.isArray(o))for(let f of o)l.push(i(f,[...r,s]));else if(typeof o=="object")for(let f of Object.keys(o)){let m=o[f];for(let p of m)l.push(i(p,[...r,`${s}:${f}`]))}}return l.flatMap(s=>s)}return[...r,String(a)].join(".")};t.fields=e.fields.flatMap(a=>i(a)).join(",")}return e.filter&&Object.keys(e.filter).length>0&&(t.filter=JSON.stringify(e.filter)),e.search&&(t.search=e.search),"sort"in e&&e.sort&&(t.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(t.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(t.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(t.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(t.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(t.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(t.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(t.groupBy=e.groupBy.join(",")),t},_=(e,t)=>{if(e.length===0)throw new Error(t)},x=(e,t)=>{if(String(e).startsWith("directus_"))throw new Error(t)},B=(e,t)=>()=>(_(String(e),"Collection cannot be empty"),x(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:t??{},method:"GET"}),N=e=>()=>({path:"/users/me",params:e??{},method:"GET"}),O={},W=(e={})=>t=>{let i={...O,...e};return{async request(a){let r=a();if(r.headers||(r.headers={}),"Content-Type"in r.headers?r.headers["Content-Type"]==="multipart/form-data"&&delete r.headers["Content-Type"]:r.headers["Content-Type"]="application/json","getToken"in this){let f=await this.getToken();f&&(r.headers||(r.headers={}),r.headers.Authorization=`Bearer ${f}`)}let l=y(t.url,r.path,r.params),s={method:r.method??"GET",headers:r.headers??{}};"credentials"in i&&(s.credentials=i.credentials),r.body&&(s.body=r.body),r.onRequest&&(s=await r.onRequest(s)),i.onRequest&&(s=await i.onRequest(s));let o=await d(l.toString(),s,t.globals.fetch);return"onResponse"in r&&(o=await r.onResponse(o,s)),"onResponse"in e&&(o=await e.onResponse(o,s)),o}}},u="/",E=(e,t)=>(e.endsWith(u)&&(e=e.slice(0,-1)),t.startsWith(u)||(t=u+t),e+t),y=(e,t,i)=>{let a=e.pathname===u?t:E(e.pathname,t),r=new globalThis.URL(a,e);if(i)for(let[l,s]of Object.entries(R(i)))if(s&&typeof s=="object"&&!Array.isArray(s))for(let[o,f]of Object.entries(s))r.searchParams.set(`${l}[${o}]`,String(f));else r.searchParams.set(l,s);return r},A=()=>{let e=null;return{get:async()=>e,set:async t=>{e=t}}},C={msRefreshBeforeExpires:3e4,autoRefresh:!0},$=(e="cookie",t={})=>i=>{let a={...C,...t},r=null,l=null,s=a.storage??A(),o=()=>{s.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},f=async()=>{try{await r}finally{r=null}},m=async()=>{let n=await s.get();if(r||!(n!=null&&n.expires_at)){await f();return}n.expires_at<new Date().getTime()+a.msRefreshBeforeExpires&&b().catch(h=>{}),await f()},p=n=>{let h=n.expires??0;n.expires_at=new Date().getTime()+h,s.set(n),a.autoRefresh&&h>a.msRefreshBeforeExpires&&h<Number.MAX_SAFE_INTEGER&&(l&&clearTimeout(l),l=setTimeout(()=>{l=null,b().catch(c=>{})},h-a.msRefreshBeforeExpires))},b=async()=>(r=(async()=>{let n=await s.get();o();let h={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in a&&(h.credentials=a.credentials);let c={mode:e};e==="json"&&(n!=null&&n.refresh_token)&&(c.refresh_token=n.refresh_token),h.body=JSON.stringify(c);let w=y(i.url,"/auth/refresh"),g=await d(w.toString(),h,i.globals.fetch);return p(g),g})().catch(n=>{throw n}),r);return{refresh:b,async login(n,h,c={}){o();let w=y(i.url,"/auth/login"),g={email:n,password:h};"otp"in c&&(g.otp=c.otp),g.mode=c.mode??e;let T={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)};"credentials"in a&&(T.credentials=a.credentials);let j=await d(w.toString(),T,i.globals.fetch);return p(j),j},async logout(){let n=await s.get(),h={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in a&&(h.credentials=a.credentials),e==="json"&&(n!=null&&n.refresh_token)&&(h.body=JSON.stringify({refresh_token:n.refresh_token}));let c=y(i.url,"/auth/logout");await d(c.toString(),h,i.globals.fetch),l&&clearTimeout(l),o()},async getToken(){var n;return await m(),((n=await s.get())==null?void 0:n.access_token)??null},setToken(n){s.set({access_token:n,refresh_token:null,expires:null,expires_at:null})}}};export{W as $,v as E,$ as U,N as V,B as Y};
