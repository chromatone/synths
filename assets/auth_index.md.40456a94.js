import{E as q,$ as Y,U as G,V as H,Y as K}from"./chunks/chunk-42TA54KX.78cd0766.js";import{r as x,e as X,o as E,c as L,a as d,t as T,u as f,w as $,v as U,i as J,f as z,g as V,_ as F}from"./chunks/framework.54b0ef20.js";function D(e){return JSON.stringify({...e,type:"auth"})}var Q=()=>JSON.stringify({type:"pong"}),M=(e,n=1e3)=>new Promise((s,y)=>{let b=h=>{try{let k=JSON.parse(h.data);typeof k=="object"&&!Array.isArray(k)&&k!==null?(p(),s(k)):(p(),i())}catch{p(),s(h)}},i=()=>y(),p=()=>{clearTimeout(m),e.removeEventListener("message",b),e.removeEventListener("error",i),e.removeEventListener("close",i)};e.addEventListener("message",b),e.addEventListener("error",i),e.addEventListener("close",i);let m=setTimeout(()=>{p(),s(void 0)},n)});function*W(){let e=1;for(;;)yield String(e),e++}var Z={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}};function ee(e={}){return n=>{e={...Z,...e};let s=null,y=W(),b=0,i=!1,p=t=>"getToken"in t,m=async(t,r)=>{if(e.authMode==="strict"&&p(r)){let o=await r.getToken();o&&t.searchParams.set("access_token",o)}return t},h=async t=>{if("url"in e)return await m(new n.globals.URL(e.url),t);if(["ws:","wss:"].includes(n.url.protocol))return await m(n.url,t);let r=new n.globals.URL(n.url.toString());return r.protocol=n.url.protocol==="https:"?"wss:":"ws:",r.pathname="/websocket",await m(r,t)},k=()=>{s=null,y=W()};function P(){e.reconnect&&!i&&b<e.reconnect.retries?(i=!0,setTimeout(()=>{b+=1,this.connect().then(()=>{b=0,i=!1}).catch(()=>{})},Math.max(1,e.reconnect.delay))):i=!1}let g={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},c=async(t,r)=>{for(;t.readyState!==WebSocket.CLOSED;){let o=await M(t).catch(()=>{});if(o){if("type"in o){if(o.type==="auth"&&"status"in o&&o.status==="error"&&"error"in o){if(o.error==="TOKEN_EXPIRED"&&p(r)){let l=await r.getToken();if(l){t.send(D({access_token:l}));continue}}if(o.error==="AUTH_TIMEOUT"){t.close();continue}}if(e.heartbeat&&o.type==="ping"){t.send(Q());continue}}g.message.forEach(l=>l.call(t,o))}}};return{async connect(){let t=this,r=await h(t);return new Promise((o,l)=>{let _=!1,u=new n.globals.WebSocket(r);u.addEventListener("open",async a=>{if(e.authMode==="handshake"&&p(t)){let w=await t.getToken();w&&u.send(D({access_token:w}))}_=!0,g.open.forEach(w=>w.call(u,a)),c(u,t),o()}),u.addEventListener("error",a=>{g.error.forEach(w=>w.call(u,a)),u.close(),_||l(a)}),u.addEventListener("close",a=>{g.close.forEach(w=>w.call(u,a)),k(),P.call(this),_||l(a)}),s=u})},disconnect(){s&&(s==null?void 0:s.readyState)===WebSocket.OPEN&&s.close(),s=null},onWebSocket(t,r){if(t==="message"){let o=function(l){if(typeof l.data!="string")return r.call(this,l);try{return r.call(this,JSON.parse(l.data))}catch{return r.call(this,l)}};return g[t].add(o),()=>g[t].delete(o)}return g[t].add(r),()=>g[t].delete(r)},sendMessage(t){if(!s||(s==null?void 0:s.readyState)!==WebSocket.OPEN)throw new Error("websocket connection not OPEN");if(typeof t=="string"){s.send(t);return}"uid"in t||(t.uid=y.next().value),s==null||s.send(JSON.stringify(t))},async subscribe(t,r={}){(!s||s.readyState!==WebSocket.OPEN)&&await this.connect(),"uid"in r||(r.uid=y.next().value);let o=!0,l=s,_=a=>l.send(JSON.stringify(a));_({...r,collection:t,type:"subscribe"});async function*u(){for(;o&&l&&l.readyState===WebSocket.OPEN;){let a=await M(l).catch(()=>{});if(a){if("type"in a&&"status"in a&&a.type==="subscribe"&&a.status==="error")throw a;"type"in a&&"uid"in a&&a.type==="subscription"&&a.uid===r.uid&&(yield a)}}if(e.reconnect&&i){for(;i;)await te(10);s&&s.readyState===WebSocket.OPEN&&(s.send(JSON.stringify({...r,collection:t,type:"subscribe"})),yield*u())}}return{subscription:u(),unsubscribe(){_({uid:r.uid,type:"unsubscribe"}),o=!1}}}}}}var te=e=>new Promise(n=>setTimeout(()=>n(),e));class re{get(){return JSON.parse(localStorage.getItem("directus-data"))}set(n){localStorage.setItem("directus-data",JSON.stringify(n))}}const v=q("https://db.synth.chromatone.center/").with(Y({credentials:"include"})).with(G("json",{credentials:"include",storage:new re})).with(ee({credentials:"include"})),S=x(),B=x(""),I=x(""),N=x({}),O=x("");let R=!1;function j(){return R||(X(async()=>{await C(),await A()}),R=!0),{access_token:O,email:B,password:I,authData:N,user:S,userDB:v,userCreate:oe,userRead:A,refreshToken:C,submitLogin:se,logoutUser:ae}}async function C(){try{let e=await v.refresh();O.value=e.access_token,delete e.access_token,N.value=e}catch(e){console.log(e.errors[0])}}async function se(){try{let e=await v.login(B.value,I.value);O.value=e.access_token,delete e.access_token,N.value={...e}}catch(e){console.log(e.errors[0])}}async function A(){try{return S.value=await v.request(H()),S.value.players=await v.request(K("players",{fields:["*",{synths:["*",{synths_id:["*"]}]}]})),S.value}catch(e){console.log(e)}}async function oe({email:e}){}async function ae(){await v.logout(),O.value="",N.value=""}const ne={class:"flex flex-col gap-4 p-4"},ie=d("div",{class:"text-xl"},"Profile",-1),le={class:"text-sm"},ce={__name:"AuthProfile",setup(e){const{user:n}=j();return(s,y)=>(E(),L("div",ne,[ie,d("pre",le,T(f(n)),1)]))}},de=d("div",{class:"text-4xl"},"Login to your account",-1),ue=d("label",{class:"text-xl",for:"email"},"E-mail*:",-1),fe=d("label",{class:"text-xl",for:"email"},"Password:",-1),pe={key:1,class:"flex flex-col gap-2"},be={class:"font-mono text-xs"},he={class:"text-sm"},ge={class:"flex"},ye={__name:"AuthLogin",setup(e){const{userRead:n,user:s,userDB:y,email:b,password:i,authData:p,access_token:m,submitLogin:h,refreshToken:k,logoutUser:P}=j();return(g,c)=>{const t=ce;return f(m)?(E(),L("div",pe,[d("p",be,"."+T(f(m).split(".")[2]),1),d("pre",he,T(f(p)),1),d("div",ge,[d("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:c[4]||(c[4]=r=>f(k)())},"Refresh"),d("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:c[5]||(c[5]=r=>f(P)())},"Log out")]),d("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:c[6]||(c[6]=r=>f(n)())},"Read user"),V(t)])):(E(),L("form",{key:0,class:"flex flex-col gap-4",onSubmit:c[3]||(c[3]=z((...r)=>f(h)&&f(h)(...r),["prevent"]))},[de,ue,$(d("input",{class:"text-lg rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",id:"email",type:"text","onUpdate:modelValue":c[0]||(c[0]=r=>J(b)?b.value=r:null)},null,512),[[U,f(b)]]),fe,$(d("input",{class:"rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",type:"password","onUpdate:modelValue":c[1]||(c[1]=r=>J(i)?i.value=r:null)},null,512),[[U,f(i)]]),d("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:c[2]||(c[2]=(...r)=>f(h)&&f(h)(...r))},"Sign In")],32))}}},ve=JSON.parse('{"title":"Login","description":"","frontmatter":{"title":"Login","desctiption":"Get in touch with community through contributions"},"headers":[],"relativePath":"auth/index.md","filePath":"auth/index.md","lastUpdated":1699000232000}'),me={name:"auth/index.md"};function ke(e,n,s,y,b,i){const p=ye;return E(),L("div",null,[V(p)])}const xe=F(me,[["render",ke]]);export{ve as __pageData,xe as default};
