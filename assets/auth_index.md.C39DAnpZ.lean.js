import{_ as G}from"./chunks/theme.U0yiKOrC.js";import{w as H,j as K,a as X,u as z,S as F}from"./chunks/chunk-LDFD35JM.27RXxW-q.js";import{r as S,o as Q,b as O,d as L,g as c,t as $,f,e as J,j as U,k as C,C as Y,y as D,_ as Z}from"./chunks/framework.5dgMT4wJ.js";function M(e){return JSON.stringify({...e,type:"auth"})}var ee=()=>JSON.stringify({type:"pong"}),R=(e,n=1e3)=>new Promise((s,m)=>{let h=b=>{try{let w=JSON.parse(b.data);typeof w=="object"&&!Array.isArray(w)&&w!==null?(p(),s(w)):(p(),i())}catch{p(),s(b)}},i=()=>m(),p=()=>{clearTimeout(g),e.removeEventListener("message",h),e.removeEventListener("error",i),e.removeEventListener("close",i)};e.addEventListener("message",h),e.addEventListener("error",i),e.addEventListener("close",i);let g=setTimeout(()=>{p(),s(void 0)},n)});function*j(){let e=1;for(;;)yield String(e),e++}var te={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}},v={OPEN:1,CLOSED:3};function re(e={}){return n=>{e={...te,...e};let s=null,m=j(),h=0,i=!1,p=t=>"getToken"in t,g=async(t,r)=>{if(e.authMode==="strict"&&p(r)){let a=await r.getToken();a&&t.searchParams.set("access_token",a)}return t},b=async t=>{if("url"in e)return await g(new n.globals.URL(e.url),t);if(["ws:","wss:"].includes(n.url.protocol))return await g(n.url,t);let r=new n.globals.URL(n.url.toString());return r.protocol=n.url.protocol==="https:"?"wss:":"ws:",r.pathname="/websocket",await g(r,t)},w=()=>{s=null,m=j()};function T(){e.reconnect&&!i&&h<e.reconnect.retries?(i=!0,setTimeout(()=>{h+=1,this.connect().then(()=>{h=0,i=!1}).catch(()=>{})},Math.max(1,e.reconnect.delay))):i=!1}let y={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},d=async(t,r)=>{for(;t.readyState!==v.CLOSED;){let a=await R(t).catch(()=>{});if(a){if("type"in a){if(a.type==="auth"&&"status"in a&&a.status==="error"&&"error"in a){if(a.error==="TOKEN_EXPIRED"&&p(r)){let l=await r.getToken();if(l){t.send(M({access_token:l}));continue}}if(a.error==="AUTH_TIMEOUT"){t.close();continue}}if(e.heartbeat&&a.type==="ping"){t.send(ee());continue}}y.message.forEach(l=>l.call(t,a))}}};return{async connect(){let t=this,r=await b(t);return new Promise((a,l)=>{let k=!1,u=new n.globals.WebSocket(r);u.addEventListener("open",async o=>{if(e.authMode==="handshake"&&p(t)){let _=await t.getToken();_&&u.send(M({access_token:_}))}k=!0,y.open.forEach(_=>_.call(u,o)),d(u,t),a()}),u.addEventListener("error",o=>{y.error.forEach(_=>_.call(u,o)),u.close(),k||l(o)}),u.addEventListener("close",o=>{y.close.forEach(_=>_.call(u,o)),w(),T.call(this),k||l(o)}),s=u})},disconnect(){s&&(s==null?void 0:s.readyState)===v.OPEN&&s.close(),s=null},onWebSocket(t,r){if(t==="message"){let a=function(l){if(typeof l.data!="string")return r.call(this,l);try{return r.call(this,JSON.parse(l.data))}catch{return r.call(this,l)}};return y[t].add(a),()=>y[t].delete(a)}return y[t].add(r),()=>y[t].delete(r)},sendMessage(t){if(!s||(s==null?void 0:s.readyState)!==v.OPEN)throw new Error("websocket connection not OPEN");if(typeof t=="string"){s.send(t);return}"uid"in t||(t.uid=m.next().value),s==null||s.send(JSON.stringify(t))},async subscribe(t,r={}){(!s||s.readyState!==v.OPEN)&&await this.connect(),"uid"in r||(r.uid=m.next().value);let a=!0,l=s,k=o=>l.send(JSON.stringify(o));k({...r,collection:t,type:"subscribe"});async function*u(){for(;a&&l&&l.readyState===v.OPEN;){let o=await R(l).catch(()=>{});if(o){if("type"in o&&"status"in o&&o.type==="subscribe"&&o.status==="error")throw o;"type"in o&&"uid"in o&&o.type==="subscription"&&o.uid===r.uid&&(yield o)}}if(e.reconnect&&i){for(;i;)await se(10);s&&s.readyState===v.OPEN&&(s.send(JSON.stringify({...r,collection:t,type:"subscribe"})),yield*u())}}return{subscription:u(),unsubscribe(){k({uid:r.uid,type:"unsubscribe"}),a=!1}}}}}}var se=e=>new Promise(n=>setTimeout(()=>n(),e));class ae{get(){return JSON.parse(localStorage.getItem("directus-data"))}set(n){localStorage.setItem("directus-data",JSON.stringify(n))}}const x=H("https://dbs.chromatone.center/").with(K({credentials:"include"})).with(X("json",{credentials:"include",storage:new ae})).with(re({credentials:"include"})),E=S(),V=S(""),W=S(""),N=S({}),P=S("");let A=!1;function q(){return A||(Q(async()=>{await B(),await I()}),A=!0),{access_token:P,email:V,password:W,authData:N,user:E,userDB:x,userCreate:ne,userRead:I,refreshToken:B,submitLogin:oe,logoutUser:ie}}async function B(){try{let e=await x.refresh();P.value=e.access_token,delete e.access_token,N.value=e}catch(e){console.log(e.errors[0])}}async function oe(){try{let e=await x.login(V.value,W.value);P.value=e.access_token,delete e.access_token,N.value={...e}}catch(e){console.log(e.errors[0])}}async function I(){try{return E.value=await x.request(z()),E.value.players=await x.request(F("players",{fields:["*",{synths:["*",{synths_id:["*"]}]}]})),E.value}catch(e){console.log(e)}}async function ne({email:e}){}async function ie(){await x.logout(),P.value="",N.value=""}const le={class:"flex flex-col gap-4 p-4"},de=c("div",{class:"text-xl"},"Profile",-1),ce={class:"text-sm"},ue={__name:"AuthProfile",setup(e){const{user:n}=q();return(s,m)=>(O(),L("div",le,[de,c("pre",ce,$(f(n)),1)]))}},fe=c("div",{class:"text-4xl"},"Login to your account",-1),pe=c("label",{class:"text-xl",for:"email"},"E-mail*:",-1),he=c("label",{class:"text-xl",for:"email"},"Password:",-1),ge={key:1,class:"flex flex-col gap-2"},be={class:"font-mono text-xs"},ye={class:"text-sm"},me={class:"flex"},we={__name:"AuthLogin",setup(e){const{userRead:n,user:s,userDB:m,email:h,password:i,authData:p,access_token:g,submitLogin:b,refreshToken:w,logoutUser:T}=q();return(y,d)=>{const t=ue;return f(g)?(O(),L("div",ge,[c("p",be,"."+$(f(g).split(".")[2]),1),c("pre",ye,$(f(p)),1),c("div",me,[c("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:d[4]||(d[4]=r=>f(w)())},"Refresh"),c("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:d[5]||(d[5]=r=>f(T)())},"Log out")]),c("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:d[6]||(d[6]=r=>f(n)())},"Read user"),D(t)])):(O(),L("form",{key:0,class:"flex flex-col gap-4",onSubmit:d[3]||(d[3]=Y((...r)=>f(b)&&f(b)(...r),["prevent"]))},[fe,pe,J(c("input",{class:"text-lg rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",id:"email",type:"text","onUpdate:modelValue":d[0]||(d[0]=r=>C(h)?h.value=r:null)},null,512),[[U,f(h)]]),he,J(c("input",{class:"rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-inner dark-bg-dark-200",type:"password","onUpdate:modelValue":d[1]||(d[1]=r=>C(i)?i.value=r:null)},null,512),[[U,f(i)]]),c("button",{class:"text-xl font-bold rounded-lg p-4 border-2 border-solid dark-border-light-300 border-dark-800 shadow-lg dark-bg-dark-200",type:"submit",onClick:d[2]||(d[2]=(...r)=>f(b)&&f(b)(...r))},"Sign In")],32))}}},Ee=JSON.parse('{"title":"Login","description":"","frontmatter":{"title":"Login","desctiption":"Get in touch with community through contributions"},"headers":[],"relativePath":"auth/index.md","filePath":"auth/index.md","lastUpdated":1706702833000}'),_e={name:"auth/index.md"};function ke(e,n,s,m,h,i){const p=we,g=G;return O(),L("div",null,[D(p),D(g)])}const Oe=Z(_e,[["render",ke]]);export{Ee as __pageData,Oe as default};
