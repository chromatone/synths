const regexVueTemplate = /<template.*?lang=['"]pug['"][^>]*?>\s*([\s\S]*?\s*)<\/template>/gm;
function extractorPug(options = {}) {
  async function compile(code, id) {
    const Pug = await import('pug');
    try {
      return Pug.compile(code, { filename: id, doctype: "html", ...options })();
    } catch {
    }
  }
  return {
    name: "pug",
    order: -1,
    async extract(ctx) {
      if (!ctx.id)
        return;
      if (ctx.id.match(/\.pug$/) || ctx.id.match(/\?vue&type=template/)) {
        try {
          ctx.code = await compile(ctx.code, ctx.id) || ctx.code;
        } catch {
        }
      } else if (ctx.id.match(/\.vue$/)) {
        const matches = Array.from(ctx.code.matchAll(regexVueTemplate));
        let tail = "";
        for (const match of matches) {
          if (match && match[1])
            tail += `
${await compile(match[1], ctx.id)}`;
        }
        if (tail)
          ctx.code = `${ctx.code}

${tail}`;
      }
      return void 0;
    }
  };
}

export { extractorPug as default };
