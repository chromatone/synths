"use strict";var j=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var I=(e,r)=>{for(var o in r)j(e,o,{get:r[o],enumerable:!0})},A=(e,r,o,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of F(r))!E.call(e,a)&&a!==o&&j(e,a,{get:()=>r[a],enumerable:!(s=P(r,a))||s.enumerable});return e};var w=e=>A(j({},"__esModule",{value:!0}),e);var k={};I(k,{authentication:()=>U,memoryStorage:()=>R,staticToken:()=>J});module.exports=w(k);var W={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL};async function D(e){let r=e.headers.get("Content-Type")?.toLowerCase();if(r?.startsWith("application/json")||r?.startsWith("application/health+json")){let o=await e.json();if(!e.ok)throw o;return"data"in o?o.data:o}if(r?.startsWith("text/html")||r?.startsWith("text/plain")){let o=await e.text();if(!e.ok)throw o;return o}}var u=async(e,r,o=globalThis.fetch)=>{r.headers=typeof r.headers=="object"&&!Array.isArray(r.headers)?r.headers:{};let s=await o(e,r);return await D(s).catch(n=>{throw{errors:typeof n=="object"&&"errors"in n?n.errors:n,response:s}})};var O=e=>{let r={};if(Array.isArray(e.fields)&&e.fields.length>0){let o=(s,a=[])=>{if(typeof s=="object"){let n=[];for(let m in s){let p=s[m]??[];if(Array.isArray(p))for(let h of p)n.push(o(h,[...a,m]));else if(typeof p=="object")for(let h of Object.keys(p)){let T=p[h];for(let f of T)n.push(o(f,[...a,`${m}:${h}`]))}}return n.flatMap(m=>m)}return[...a,String(s)].join(".")};r.fields=e.fields.flatMap(s=>o(s)).join(",")}return e.filter&&Object.keys(e.filter).length>0&&(r.filter=JSON.stringify(e.filter)),e.search&&(r.search=e.search),"sort"in e&&e.sort&&(r.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(r.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(r.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(r.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(r.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(r.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(r.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(r.groupBy=e.groupBy.join(",")),r};var b="/",N=(e,r)=>(e.endsWith(b)&&(e=e.slice(0,-1)),r.startsWith(b)||(r=b+r),e+r),y=(e,r,o)=>{let s=e.pathname===b?r:N(e.pathname,r),a=new globalThis.URL(s,e);if(o)for(let[n,m]of Object.entries(O(o)))if(m&&typeof m=="object"&&!Array.isArray(m))for(let[p,h]of Object.entries(m))a.searchParams.set(`${n}[${p}]`,String(h));else a.searchParams.set(n,m);return a};var R=()=>{let e=null;return{get:async()=>e,set:async r=>{e=r}}};var v={msRefreshBeforeExpires:3e4,autoRefresh:!0},U=(e="cookie",r={})=>o=>{let s={...v,...r},a=null,n=null,m=s.storage??R(),p=()=>{m.set({access_token:null,refresh_token:null,expires:null,expires_at:null})},h=async()=>{try{await a}finally{a=null}},T=async()=>{let i=await m.get();if(a||!i?.expires_at){await h();return}i.expires_at<new Date().getTime()+s.msRefreshBeforeExpires&&C().catch(c=>{}),await h()},f=i=>{let c=i.expires??0;i.expires_at=new Date().getTime()+c,m.set(i),s.autoRefresh&&c>s.msRefreshBeforeExpires&&c<Number.MAX_SAFE_INTEGER&&(n&&clearTimeout(n),n=setTimeout(()=>{n=null,C().catch(d=>{})},c-s.msRefreshBeforeExpires))},C=async()=>(a=(async()=>{let c=await m.get();p();let d={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in s&&(d.credentials=s.credentials);let x={mode:e};e==="json"&&c?.refresh_token&&(x.refresh_token=c.refresh_token),d.body=JSON.stringify(x);let S=y(o.url,"/auth/refresh"),l=await u(S.toString(),d,o.globals.fetch);return f(l),l})().catch(c=>{throw c}),a);return{refresh:C,async login(i,c,d={}){p();let x=y(o.url,"/auth/login"),S={email:i,password:c};"otp"in d&&(S.otp=d.otp),S.mode=d.mode??e;let l={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)};"credentials"in s&&(l.credentials=s.credentials);let g=await u(x.toString(),l,o.globals.fetch);return f(g),g},async logout(){let i=await m.get(),c={method:"POST",headers:{"Content-Type":"application/json"}};"credentials"in s&&(c.credentials=s.credentials),e==="json"&&i?.refresh_token&&(c.body=JSON.stringify({refresh_token:i.refresh_token}));let d=y(o.url,"/auth/logout");await u(d.toString(),c,o.globals.fetch),n&&clearTimeout(n),p()},async getToken(){return await T(),(await m.get())?.access_token??null},setToken(i){m.set({access_token:i,refresh_token:null,expires:null,expires_at:null})}}};var J=e=>r=>{let o=e??null;return{async getToken(){return o},setToken(s){o=s}}};0&&(module.exports={authentication,memoryStorage,staticToken});
//# sourceMappingURL=index.cjs.map