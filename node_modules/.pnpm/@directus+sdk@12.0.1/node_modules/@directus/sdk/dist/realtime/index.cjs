"use strict";var W=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var L=(t,s)=>{for(var n in s)W(t,n,{get:s[n],enumerable:!0})},N=(t,s,n,d)=>{if(s&&typeof s=="object"||typeof s=="function")for(let u of A(s))!T.call(t,u)&&u!==n&&W(t,u,{get:()=>s[u],enumerable:!(d=O(s,u))||d.enumerable});return t};var R=t=>N(W({},"__esModule",{value:!0}),t);var U={};L(U,{auth:()=>g,generateUid:()=>k,messageCallback:()=>E,pong:()=>w,realtime:()=>P,sleep:()=>v});module.exports=R(U);function g(t){return JSON.stringify({...t,type:"auth"})}var w=()=>JSON.stringify({type:"pong"});var E=(t,s=1e3)=>new Promise((n,d)=>{let u=y=>{try{let f=JSON.parse(y.data);typeof f=="object"&&!Array.isArray(f)&&f!==null?(h(),n(f)):(h(),l())}catch{h(),n(y)}},l=()=>d(),h=()=>{clearTimeout(m),t.removeEventListener("message",u),t.removeEventListener("error",l),t.removeEventListener("close",l)};t.addEventListener("message",u),t.addEventListener("error",l),t.addEventListener("close",l);let m=setTimeout(()=>{h(),n(void 0)},s)});function*k(){let t=1;for(;;)yield String(t),t++}var M={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}};function P(t={}){return s=>{t={...M,...t};let n=null,d=k(),u=0,l=!1,h=e=>"getToken"in e,m=async(e,r)=>{if(t.authMode==="strict"&&h(r)){let o=await r.getToken();o&&e.searchParams.set("access_token",o)}return e},y=async e=>{if("url"in t)return await m(new s.globals.URL(t.url),e);if(["ws:","wss:"].includes(s.url.protocol))return await m(s.url,e);let r=new s.globals.URL(s.url.toString());return r.protocol=s.url.protocol==="https:"?"wss:":"ws:",r.pathname="/websocket",await m(r,e)},f=()=>{n=null,d=k()};function C(){t.reconnect&&!l&&u<t.reconnect.retries?(l=!0,setTimeout(()=>{u+=1,this.connect().then(()=>{u=0,l=!1}).catch(()=>{})},Math.max(1,t.reconnect.delay))):l=!1}let S={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},x=async(e,r)=>{for(;e.readyState!==WebSocket.CLOSED;){let o=await E(e).catch(()=>{});if(o){if("type"in o){if(o.type==="auth"&&"status"in o&&o.status==="error"&&"error"in o){if(o.error==="TOKEN_EXPIRED"&&h(r)){let a=await r.getToken();if(a){e.send(g({access_token:a}));continue}}if(o.error==="AUTH_TIMEOUT"){e.close();continue}}if(t.heartbeat&&o.type==="ping"){e.send(w());continue}}S.message.forEach(a=>a.call(e,o))}}};return{async connect(){let e=this,r=await y(e);return new Promise((o,a)=>{let b=!1,c=new s.globals.WebSocket(r);c.addEventListener("open",async i=>{if(t.authMode==="handshake"&&h(e)){let p=await e.getToken();p&&c.send(g({access_token:p}))}b=!0,S.open.forEach(p=>p.call(c,i)),x(c,e),o()}),c.addEventListener("error",i=>{S.error.forEach(p=>p.call(c,i)),c.close(),b||a(i)}),c.addEventListener("close",i=>{S.close.forEach(p=>p.call(c,i)),f(),C.call(this),b||a(i)}),n=c})},disconnect(){n&&n?.readyState===WebSocket.OPEN&&n.close(),n=null},onWebSocket(e,r){if(e==="message"){let o=function(a){if(typeof a.data!="string")return r.call(this,a);try{return r.call(this,JSON.parse(a.data))}catch{return r.call(this,a)}};return S[e].add(o),()=>S[e].delete(o)}return S[e].add(r),()=>S[e].delete(r)},sendMessage(e){if(!n||n?.readyState!==WebSocket.OPEN)throw new Error("websocket connection not OPEN");if(typeof e=="string"){n.send(e);return}"uid"in e||(e.uid=d.next().value),n?.send(JSON.stringify(e))},async subscribe(e,r={}){(!n||n.readyState!==WebSocket.OPEN)&&await this.connect(),"uid"in r||(r.uid=d.next().value);let o=!0,a=n,b=i=>a.send(JSON.stringify(i));b({...r,collection:e,type:"subscribe"});async function*c(){for(;o&&a&&a.readyState===WebSocket.OPEN;){let i=await E(a).catch(()=>{});if(i){if("type"in i&&"status"in i&&i.type==="subscribe"&&i.status==="error")throw i;"type"in i&&"uid"in i&&i.type==="subscription"&&i.uid===r.uid&&(yield i)}}if(t.reconnect&&l){for(;l;)await v(10);n&&n.readyState===WebSocket.OPEN&&(n.send(JSON.stringify({...r,collection:e,type:"subscribe"})),yield*c())}}return{subscription:c(),unsubscribe(){b({uid:r.uid,type:"unsubscribe"}),o=!1}}}}}}var v=t=>new Promise(s=>setTimeout(()=>s(),t));0&&(module.exports={auth,generateUid,messageCallback,pong,realtime,sleep});
//# sourceMappingURL=index.cjs.map