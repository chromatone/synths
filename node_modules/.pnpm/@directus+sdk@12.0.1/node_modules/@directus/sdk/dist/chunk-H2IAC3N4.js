function g(t){return JSON.stringify({...t,type:"auth"})}var W=()=>JSON.stringify({type:"pong"});var E=(t,u=1e3)=>new Promise((o,b)=>{let p=y=>{try{let S=JSON.parse(y.data);typeof S=="object"&&!Array.isArray(S)&&S!==null?(l(),o(S)):(l(),c())}catch{l(),o(y)}},c=()=>b(),l=()=>{clearTimeout(m),t.removeEventListener("message",p),t.removeEventListener("error",c),t.removeEventListener("close",c)};t.addEventListener("message",p),t.addEventListener("error",c),t.addEventListener("close",c);let m=setTimeout(()=>{l(),o(void 0)},u)});function*k(){let t=1;for(;;)yield String(t),t++}var x={authMode:"handshake",heartbeat:!0,reconnect:{delay:1e3,retries:10}};function j(t={}){return u=>{t={...x,...t};let o=null,b=k(),p=0,c=!1,l=e=>"getToken"in e,m=async(e,n)=>{if(t.authMode==="strict"&&l(n)){let r=await n.getToken();r&&e.searchParams.set("access_token",r)}return e},y=async e=>{if("url"in t)return await m(new u.globals.URL(t.url),e);if(["ws:","wss:"].includes(u.url.protocol))return await m(u.url,e);let n=new u.globals.URL(u.url.toString());return n.protocol=u.url.protocol==="https:"?"wss:":"ws:",n.pathname="/websocket",await m(n,e)},S=()=>{o=null,b=k()};function v(){t.reconnect&&!c&&p<t.reconnect.retries?(c=!0,setTimeout(()=>{p+=1,this.connect().then(()=>{p=0,c=!1}).catch(()=>{})},Math.max(1,t.reconnect.delay))):c=!1}let d={open:new Set([]),error:new Set([]),close:new Set([]),message:new Set([])},C=async(e,n)=>{for(;e.readyState!==WebSocket.CLOSED;){let r=await E(e).catch(()=>{});if(r){if("type"in r){if(r.type==="auth"&&"status"in r&&r.status==="error"&&"error"in r){if(r.error==="TOKEN_EXPIRED"&&l(n)){let i=await n.getToken();if(i){e.send(g({access_token:i}));continue}}if(r.error==="AUTH_TIMEOUT"){e.close();continue}}if(t.heartbeat&&r.type==="ping"){e.send(W());continue}}d.message.forEach(i=>i.call(e,r))}}};return{async connect(){let e=this,n=await y(e);return new Promise((r,i)=>{let f=!1,a=new u.globals.WebSocket(n);a.addEventListener("open",async s=>{if(t.authMode==="handshake"&&l(e)){let h=await e.getToken();h&&a.send(g({access_token:h}))}f=!0,d.open.forEach(h=>h.call(a,s)),C(a,e),r()}),a.addEventListener("error",s=>{d.error.forEach(h=>h.call(a,s)),a.close(),f||i(s)}),a.addEventListener("close",s=>{d.close.forEach(h=>h.call(a,s)),S(),v.call(this),f||i(s)}),o=a})},disconnect(){o&&o?.readyState===WebSocket.OPEN&&o.close(),o=null},onWebSocket(e,n){if(e==="message"){let r=function(i){if(typeof i.data!="string")return n.call(this,i);try{return n.call(this,JSON.parse(i.data))}catch{return n.call(this,i)}};return d[e].add(r),()=>d[e].delete(r)}return d[e].add(n),()=>d[e].delete(n)},sendMessage(e){if(!o||o?.readyState!==WebSocket.OPEN)throw new Error("websocket connection not OPEN");if(typeof e=="string"){o.send(e);return}"uid"in e||(e.uid=b.next().value),o?.send(JSON.stringify(e))},async subscribe(e,n={}){(!o||o.readyState!==WebSocket.OPEN)&&await this.connect(),"uid"in n||(n.uid=b.next().value);let r=!0,i=o,f=s=>i.send(JSON.stringify(s));f({...n,collection:e,type:"subscribe"});async function*a(){for(;r&&i&&i.readyState===WebSocket.OPEN;){let s=await E(i).catch(()=>{});if(s){if("type"in s&&"status"in s&&s.type==="subscribe"&&s.status==="error")throw s;"type"in s&&"uid"in s&&s.type==="subscription"&&s.uid===n.uid&&(yield s)}}if(t.reconnect&&c){for(;c;)await w(10);o&&o.readyState===WebSocket.OPEN&&(o.send(JSON.stringify({...n,collection:e,type:"subscribe"})),yield*a())}}return{subscription:a(),unsubscribe(){f({uid:n.uid,type:"unsubscribe"}),r=!1}}}}}}var w=t=>new Promise(u=>setTimeout(()=>u(),t));export{g as a,W as b,E as c,k as d,j as e,w as f};
//# sourceMappingURL=chunk-H2IAC3N4.js.map